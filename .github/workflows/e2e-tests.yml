name: E2E Tests

on:
  deployment_status:
    types: [success]

jobs:
  run-e2es:
    if: github.event.deployment_status.state == 'success'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 20

      - name: Install Dependencies
        run: npm ci

      - name: Install Puppeteer Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libnss3 \
            libxss1 \
            libasound2 \
            libatk1.0-0 \
            libatk-bridge2.0-0 \
            libcups2 \
            libdrm2 \
            libgbm1 \
            libgtk-3-0 \
            libxcomposite1 \
            libxdamage1 \
            libxrandr2 \
            xdg-utils \
            --no-install-recommends

      - name: Run E2E Tests
        run: npm run test:e2e
        env:
          BASE_URL: ${{ github.event.deployment_status.environment_url }}
